<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Attendance Management System</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7;}
        .container { max-width: 920px; margin: 32px auto; background: #fff; padding: 24px; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,.08);}
        .loginbox { max-width: 340px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 16px;}
        h2 { text-align: center; margin-bottom: 18px;}
        label { margin-top:12px; display: block;}
        input[type="text"], input[type="password"], input[type="date"] { padding:8px; margin:6px 0 10px 0; width:100%; border-radius:6px; border:1px solid #ccc;}
        button { background: #298afb; color: white; border: none; padding: 10px 18px; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 10px;}
        button:hover { background: #2374d7;}
        th { background: #ffe59b;}
        tr:nth-child(even) { background: #f9f9f9;}
        table { width: 100%; border-collapse: collapse; margin-top: 18px;}
        th, td { padding: 8px 10px; border-bottom: 1px solid #eee; text-align: left;}
        .status-btn { padding: 6px 18px; margin-right: 5px; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-weight: bold;}
        .present-btn { background: #90ee90; }
        .absent-btn { background: #f7b7b7; }
        .permission-btn { background: #f7d8b7; }
        .active { border: 2px solid #222; box-shadow: 0 0 8px #ddd;}
        .hidden { display:none; }
        #dateInput { padding:6px; border-radius:6px; border:1px solid #ccc; margin-right:10px;}
        .btn-wide { padding: 8px 20px; border-radius:6px; border:none; cursor:pointer; margin:14px 4px; }
        #saveAllBtn { background:#4a654a; color:#fff;}
        #downloadBtn { background:#795548; color:#fff;}
        #downloadWeeklyBtn { background:#5a4d7a; color:#fff;}
        .error { color: #f44336;}
        .success { color: #16c79a;}
        .section-buttons button { margin-right: 10px; }
        nav { text-align: center; margin-top: 20px; }
        nav button { margin: 0 10px; padding: 8px 16px; cursor: pointer; }
    </style>
</head>
<body>

<nav>
    <button onclick="showView('adminLogin')">Admin Login</button>
    <button onclick="showView('studentLogin')">Student Attendance</button>
</nav>

<!-- Admin Login -->
<div id="adminLogin" class="loginbox">
    <h2>Admin Login</h2>
    <div id="logmsg"></div>
    <label for="username">Username:</label>
    <input type="text" id="username" autocomplete="username" />
    <label for="password">Password:</label>
    <input type="password" id="password" autocomplete="current-password" />
    <button onclick="login()">Login</button>
    <br />
    <a href="#" onclick="forgotpw();return false;" style="color:#298afb;">Forgot Password?</a>
</div>

<!-- Admin Attendance Section -->
<div id="attendance" class="container hidden">
    <h2>Attendance Management Chart</h2>
    <div id="savemsg"></div>
    <label for="dateInput">Date:</label>
    <input type="date" id="dateInput" />
    <button id="saveAllBtn" class="btn-wide">Save All Sections</button>
    <button id="downloadBtn" class="btn-wide">Download Absentees & Permissions</button>
    <button id="downloadWeeklyBtn" class="btn-wide">Download Weekly Report</button>
    <br /><br />
    <label><b>Check Attendance Status for a Person:</b></label><br />
    <input type="text" id="checkRegInput" placeholder="Registration Number (e.g. 23KD1A05D3)" style="width:220px; display:inline-block;" />
    <input type="date" id="checkDateInput" style="width:160px; display:inline-block;" />
    <button onclick="checkStatus()" style="background:#198754;">Check</button>
    <span id="checkResult"></span>
    <br /><br />
    <div class="section-buttons">
        <button onclick="showSection('A')">Section A</button>
        <button onclick="showSection('B')">Section B</button>
        <button onclick="showSection('C')">Section C</button>
        <button onclick="showSection('D')">Section D</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Reg Number</th>
                <th>Name</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="attBody"></tbody>
    </table>
    <button onclick="logoutAdmin()" style="margin-top:20px; background:#d9534f;">Logout</button>
</div>

<!-- Student Attendance Check -->
<div id="studentLogin" class="loginbox hidden">
    <h2>Student Attendance Check</h2>
    <div id="stuLoginMsg" class="error"></div>
    <label for="stuUsername">Enter Your Registration Number:</label>
    <input type="text" id="stuUsername" placeholder="e.g. 23KD1A05H2" />
    <label for="stuDate">Select Date:</label>
    <input type="date" id="stuDate" />
    <button onclick="checkStudentAttendance()">Check Attendance</button>
    <div id="stuAttendanceResult" style="margin-top:15px; font-weight:bold;"></div>
    <button onclick="logoutStudent()" style="margin-top:20px; background:#d9534f;">Logout</button>
</div>

<script>
const sectionStudents = {
  // Use your full section data here (A, B, C, D). For brevity, only some are listed.
  A: [
    ['23KD1A0501', 'ABDUL GUFFRAN'],['23KD1A0502', 'ADAPAKA TEJASRI'],['23KD1A0503', 'ADDANKI MAHESWARI']
    // ... Add all students in Section A
  ],
  B: [
    ['23KD1A0567', 'GRANDHI MANASA'],['23KD1A0568', 'GUDDALA JAHNAVI']
    // ... Add all students in Section B
  ],
  C: [
    ['23KD1A05D3', 'M BHARGAVI'],['23KD1A05D4', 'M PRAVALLIKA']
    // ... Add all students in Section C
  ],
  D: [
    ['23KD1A05J9', 'PORAPU PADMA'],['23KD1A05K0', 'POTHINA APPALA DURGA GUNA MANASA SREE']
    // ... Add all students in Section D
  ]
};

let attendance = {};
let currentSection = 'A';

function showView(viewId) {
    document.getElementById('adminLogin').classList.add('hidden');
    document.getElementById('attendance').classList.add('hidden');
    document.getElementById('studentLogin').classList.add('hidden');
    document.getElementById(viewId).classList.remove('hidden');
}

function login() {
    let u = document.getElementById('username').value.trim();
    let p = document.getElementById('password').value.trim();
    fetch('/api/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username:u, password:p})
    }).then(resp => resp.json()).then(data => {
        if(data.success){
            showView('attendance');
            let today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            document.getElementById('checkDateInput').value = today;
            showSection('A');
        } else {
            document.getElementById('logmsg').innerHTML = '<div class="error">' + data.error + '</div>';
        }
    });
}

function logoutAdmin() {
    attendance = {};
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('logmsg').innerHTML = '';
    showView('adminLogin');
}

function forgotpw() {
    let u = document.getElementById('username').value.trim() || '';
    fetch('/api/forgot_password', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username:u})
    }).then(resp => resp.json()).then(data =>{
        if(data.success){
            document.getElementById('logmsg').innerHTML = '<div class="success">Reset link sent to admin email.</div>';
        } else {
            document.getElementById('logmsg').innerHTML = `<div class="error">${data.error}</div>`;
        }
    });
}

function showSection(sec) {
  currentSection = sec;
  let date = document.getElementById('dateInput').value || new Date().toISOString().split('T')[0];
  renderTable(date);
}

function renderTable(date) {
    let tbody = document.getElementById('attBody');
    tbody.innerHTML = '';
    sectionStudents[currentSection].forEach(([reg,name]) => {
        let stat = (attendance[date] && attendance[date][reg]) || "Present";
        let tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${reg}</td>
            <td>${name}</td>
            <td>
                <button class="status-btn present-btn${stat=='Present'?' active':''}" onclick="setStatus('${reg}','Present',this)">Present</button>
                <button class="status-btn absent-btn${stat=='Absent'?' active':''}" onclick="setStatus('${reg}','Absent',this)">Absent</button>
                <button class="status-btn permission-btn${stat=='Permission'?' active':''}" onclick="setStatus('${reg}','Permission',this)">Permission</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function setStatus(reg, status, btn) {
    let date = document.getElementById('dateInput').value || new Date().toISOString().split('T')[0];
    if (!attendance[date]) attendance[date] = {};
    attendance[date][reg] = status;
    let td = btn.parentNode;
    [...td.children].forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

document.getElementById('dateInput').onchange = function() {
    renderTable(this.value);
};

document.getElementById('saveAllBtn').onclick = function() {
    let date = document.getElementById('dateInput').value || new Date().toISOString().split('T')[0];
    let allAttendance = {};
    ['A','B','C','D'].forEach(sec => {
        sectionStudents[sec].forEach(([reg, name]) => {
            let status = (attendance[date] && attendance[date][reg]) || "Present";
            allAttendance[reg] = {name: name, status: status, section: sec};
        });
    });
    fetch('/api/save', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({date: date, attendance: allAttendance})
    }).then(resp => resp.json()).then(data => {
        if(data.success){
            document.getElementById('savemsg').innerHTML = '<div class="success">All sections attendance saved for ' + date + '</div>';
            setTimeout(() => { document.getElementById('savemsg').innerHTML = ''; }, 3000);
        }
    });
};

document.getElementById('downloadBtn').onclick = function() {
    let date = document.getElementById('dateInput').value || new Date().toISOString().split('T')[0];
    fetch('/api/export_absentees/?date=' + date).then(resp => resp.blob()).then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `absentees_permissions_${date}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
    });
};

document.getElementById('downloadWeeklyBtn').onclick = function() {
    let startDate = document.getElementById('dateInput').value || new Date().toISOString().split('T')[0];
    fetch(`/api/export_weekly_report/?start_date=${startDate}`).then(resp => resp.blob()).then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `weekly_attendance_${startDate}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
    });
};

function checkStatus() {
    let reg = document.getElementById('checkRegInput').value.trim().toUpperCase();
    let date = document.getElementById('checkDateInput').value;
    if(!reg || !date){
        document.getElementById('checkResult').innerHTML = '<span class="error">Enter reg. number and date</span>';
        return;
    }
    fetch(`/api/check?regno=${reg}&date=${date}`)
    .then(resp => resp.json())
    .then(data => {
        document.getElementById('checkResult').innerText = `${reg} was marked as '${data.status}' on ${date}`;
    });
}

function checkStudentAttendance() {
    let regno = document.getElementById('stuUsername').value.trim().toUpperCase();
    let date = document.getElementById('stuDate').value;
    if(!regno){
        document.getElementById('stuLoginMsg').innerText = 'Enter your registration number';
        return;
    }
    if(!date){
        document.getElementById('stuAttendanceResult').innerText = "Please select a date";
        return;
    }
    fetch('/api/student_login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username: regno})
    }).then(resp => resp.json()).then(data => {
        if(data.success){
            fetch(`/api/student/check_attendance?regno=${regno}&date=${date}`)
            .then(resp => resp.json())
            .then(data => {
                document.getElementById('stuAttendanceResult').innerText = `Your attendance on ${date} is: ${data.status}`;
                document.getElementById('stuLoginMsg').innerText = '';
            });
        } else {
            document.getElementById('stuLoginMsg').innerText = data.error || "Invalid registration number";
            document.getElementById('stuAttendanceResult').innerText = '';
        }
    });
}

function logoutStudent() {
    document.getElementById('stuUsername').value = '';
    document.getElementById('stuDate').value = '';
    document.getElementById('stuLoginMsg').innerText = '';
    document.getElementById('stuAttendanceResult').innerText = '';
}

window.onload = function() {
    showView('adminLogin');
};
</script>
</body>
</html>
